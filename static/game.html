<!doctype html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/static/img-res/favicon.ico">
</head>
<body>
    <div class="holder-first row-fluid">
        <div class="container">
            <img src="/static/img-res/logo.png" width="100" height="100" class="logo">
            <h1 align="center"> Multiplayer Quiz Game </h1>
            <div class="row" id="game-window">
                <div class="col-lg-3 col-md-3 col-sm-6 col-xs-6 pull-left">
                    <table id="users"></table>
                </div>
                <button id="ready-to-go" class="btn btn-success btn-lg">Ready to go</button>
            </div>
            <div class="row" id="game" style="display:none;">
                <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12" id="ef-playerlist">
                        <table id="efusers"></table>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12" id="ef-game">
                    <div id="ef-question"></div>
                    <div id="ef-answers"></div>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12" id="ef-abilities">
                    <img src="/static/img-res/lightning.png" width="40" height="40" id="ef-pd" class="ab-btns">
                    <img src="/static/img-res/person.png" width="40" height="40" id="ef-re" class="ab-btns">
                    <img src="/static/img-res/time.png" width="40" height="40" id="ef-mt" class="ab-btns">
                </div>
            </div>
        </div>
    </div>
<script>
//Establish the WebSocket connection and set up event handlers
function findGetParameter(parameterName) {
    var result = null,
    tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
    }
    return result;
}
var gameRoom = findGetParameter('room');//get room param
var urlwebs = "ws://" + location.hostname + ":" + location.port + "/api/game_socket/"+gameRoom;


function start(urlwebs) {
    webSocket = new WebSocket(urlwebs);
}
webSocket = new WebSocket(urlwebs);
webSocket.onclose = function(){
    setTimeout(function(){start(urlwebs)}, 2000);
};

$(document).ready(function(){
    webSocket.onmessage = function (e) {
        var obj = JSON.parse(e.data);
        console.log(obj);


        if(obj.ready == true) {
            $('#game-window').hide();
            $('#game').show();
            showQuestion(obj);
        }
    };
    webSocket.onerror = function(e) {
        console.log(e.data);
    }; 
   
   $("#ready-to-go").click(function(){
        $("#ready-to-go").toggleClass('btn-success btn-danger');
        $("#ready-to-go").html('Se asteapta restul jucatorilor...');
        webSocket.send("READY");
   });
});

// ENDTURN dupa 5 secunde
document.body.addEventListener('click', checkEvent, true); 
function checkEvent(e) {
    efid = e.target.id;
    if(efid == 'ef-pd' || efid == 'ef-re' || efid == 'ef-mt') {
        webSocket.send("ABILITY "+efid);
    }
}
function showQuestion(obj) {
    if(obj.questionNr != '-1') {
        $("#ef-question").html(obj.questions[obj.questionNr].text);
        if(obj.questions[obj.questionNr].typeq == '0') {
            var answer = '';
            var i;
            var arAnswers = obj.questions[obj.questionNr].answers;
            for (i = 0; i < arAnswers.length; i++) { 
                answer += '<div id="'+i+'" class="answer-form">'+arAnswers[i]+'</div>';
            }
            $("#ef-answers").html(answer);
        } else {
            $("#ef-answers").html('<input type="number" value="" class="form-control" id="answer-'+obj.questionNr+'">');
        }
        
    }
}
</script>
</body>
</html>